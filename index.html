<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConnX TransitIQ ‚Äî Rate Your Ride</title>

  <style>
    :root{
      /* ‚ùÑÔ∏è Snowy blue theme */
      --ice0:#071a2f;
      --ice1:#0a2a4a;
      --ice2:#0e3a63;
      --ice3:#2a5d88;

      --card:#ffffff;
      --text:#0b1220;
      --muted:#334155;
      --line:#d9e6f1;

      --mono: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html, body{ height: 100%; }

    body{
      margin:0;
      display:grid;
      place-items:center;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 18% 16%, rgba(255,255,255,0.10), transparent 60%),
        radial-gradient(720px 440px at 82% 84%, rgba(42,93,136,0.25), transparent 55%),
        linear-gradient(180deg, var(--ice2), var(--ice0));
    }

    /* ‚úÖ Shimmery icy widget */
    .app{
      width: 500px;
      height: 350px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(217,230,241,0.92);
      box-shadow:
        0 18px 40px rgba(0,0,0,0.35),
        0 2px 0 rgba(255,255,255,0.12) inset;
      display:grid;
      grid-template-rows: 46px 1fr 118px;
      position: relative;

      background:
        radial-gradient(12px 12px at 12% 22%, rgba(255,255,255,0.95), rgba(255,255,255,0) 60%),
        radial-gradient(10px 10px at 78% 34%, rgba(255,255,255,0.90), rgba(255,255,255,0) 62%),
        radial-gradient(8px 8px at 52% 70%, rgba(255,255,255,0.85), rgba(255,255,255,0) 62%),
        radial-gradient(14px 14px at 90% 78%, rgba(255,255,255,0.88), rgba(255,255,255,0) 60%),
        repeating-linear-gradient(
          135deg,
          rgba(42,93,136,0.00) 0px,
          rgba(42,93,136,0.00) 6px,
          rgba(42,93,136,0.045) 6px,
          rgba(42,93,136,0.045) 8px
        ),
        linear-gradient(180deg, #ffffff, #f3fbff);
    }

    /* shimmer sweep */
    .app::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(
        120deg,
        rgba(255,255,255,0.00) 35%,
        rgba(255,255,255,0.40) 45%,
        rgba(255,255,255,0.00) 55%
      );
      transform: translateX(-45%) rotate(8deg);
      animation: shimmerSweep 3.2s linear infinite;
      pointer-events:none;
      z-index: 1;
      mix-blend-mode: screen;
      opacity: 0.9;
    }
    .app > *{ position: relative; z-index: 2; }
    @keyframes shimmerSweep{
      0%   { transform: translateX(-45%) rotate(8deg); }
      100% { transform: translateX(45%) rotate(8deg); }
    }

    /* Bold-ish */
    .app, .app *{ font-weight: 650; }
    .brand .name{ font-weight: 900; letter-spacing: 0.2px; }

    .topbar{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--line);
      background: rgba(240, 252, 255, 0.70);
      position: relative;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; user-select:none; }
    .brand .name{ font-size: 13px; line-height:1; }
    .brand .status{ font-size: 11px; color: var(--muted); line-height:1.2; }

    /* fake progress */
    .fakeProgress{
      position:absolute;
      left: 12px;
      right: 12px;
      bottom: -6px;
      height: 9px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.90);
      pointer-events:none;
      overflow:hidden;
      opacity: 0.95;
    }
    .fakeProgress > i{
      display:block;
      height: 100%;
      width: 23%;
      background: rgba(42,93,136,0.14);
      border-right: 1px solid rgba(42,93,136,0.22);
      animation: fakeLoad 4.8s ease-in-out infinite;
    }
    @keyframes fakeLoad{
      0%{ transform: translateX(0%); }
      50%{ transform: translateX(240%); }
      100%{ transform: translateX(0%); }
    }

    /* ‚ùÑÔ∏è Snow-themed chat backdrop */
    .chat{
      padding: 10px 12px;
      overflow: auto;
      display:flex;
      flex-direction:column;
      gap:9px;

      position: relative;
      transform: rotate(-0.35deg); /* bad ui */
      transform-origin: top left;

      background:
        radial-gradient(10px 10px at 12% 18%, rgba(255,255,255,0.95) 0 35%, rgba(255,255,255,0) 60%),
        radial-gradient(8px 8px at 76% 26%, rgba(255,255,255,0.90) 0 35%, rgba(255,255,255,0) 60%),
        radial-gradient(7px 7px at 42% 64%, rgba(255,255,255,0.92) 0 35%, rgba(255,255,255,0) 60%),
        radial-gradient(9px 9px at 88% 72%, rgba(255,255,255,0.88) 0 35%, rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(214,241,255,0.92), rgba(255,255,255,0.80));

      border-top: 1px solid rgba(217,230,241,0.9);
    }

    .chat::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(200px 140px at 18% 18%, rgba(42,93,136,0.12), transparent 62%),
        radial-gradient(220px 160px at 82% 86%, rgba(42,93,136,0.11), transparent 62%),

        radial-gradient(circle at 18% 22%, rgba(255,255,255,0.34) 0 2px, transparent 3px),
        radial-gradient(circle at 32% 38%, rgba(255,255,255,0.30) 0 2px, transparent 3px),
        radial-gradient(circle at 48% 28%, rgba(255,255,255,0.35) 0 2px, transparent 3px),
        radial-gradient(circle at 60% 52%, rgba(255,255,255,0.30) 0 2px, transparent 3px),
        radial-gradient(circle at 74% 34%, rgba(255,255,255,0.36) 0 2px, transparent 3px),
        radial-gradient(circle at 86% 62%, rgba(255,255,255,0.32) 0 2px, transparent 3px),
        radial-gradient(circle at 40% 74%, rgba(255,255,255,0.34) 0 2px, transparent 3px),
        radial-gradient(circle at 68% 80%, rgba(255,255,255,0.30) 0 2px, transparent 3px);
      opacity: 0.75;
      filter: blur(0.2px);
      animation: snowDrift 7s linear infinite;
    }

    @keyframes snowDrift{
      0%   { transform: translateY(-6px) translateX(0px); }
      50%  { transform: translateY(6px) translateX(6px); }
      100% { transform: translateY(-6px) translateX(0px); }
    }

    .chat::before{
      content:"ConnX TransitIQ ‚Ä¢ definitely official ‚Ä¢ v0.0.0.0.1";
      position:absolute;
      top: 6px;
      right: 10px;
      font-family: var(--mono);
      font-size: 9px;
      color: rgba(15,23,42,0.14);
      transform: rotate(2.3deg);
      pointer-events:none;
      user-select:none;
      white-space:nowrap;
      z-index: 2;
    }

    .row{ display:flex; gap:8px; align-items:flex-end; }
    .row.user{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }

    .avatar{
      width: 24px; height: 24px;
      border-radius: 8px;
      border: 1px solid var(--line);
      display:grid; place-items:center;
      font-size: 11px;
      user-select:none;
      background: rgba(255,255,255,0.90);
      flex: 0 0 auto;
      font-weight: 900;
    }

    .bubble{
      max-width: 78%;
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(217,230,241,0.95);
      background: rgba(255,255,255,0.90);
      font-size: 12px;
      line-height: 1.28;
      position: relative;
    }
    .bubble::after{
      content:"PRIORITY";
      position:absolute;
      top:-8px;
      right:10px;
      font-size: 8px;
      font-family: var(--mono);
      color: rgba(10,42,74,0.70);
      background: rgba(42,93,136,0.10);
      border: 1px solid rgba(42,93,136,0.18);
      padding: 2px 6px;
      border-radius: 999px;
      transform: rotate(2.6deg);
      opacity: 0.55;
      pointer-events:none;
      user-select:none;
      font-weight: 900;
    }

    .meta{
      margin-top: 6px;
      color: var(--muted);
      font-size: 10px;
      font-family: var(--mono);
      user-select:none;
      font-weight: 750;
    }

    .ratingStage{
      position: relative;
      border-top: 1px solid var(--line);
      background: rgba(240, 252, 255, 0.70);
      padding: 8px 12px 10px;
      height: 118px;
      overflow: hidden;
    }

    .stageHint{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size: 11px;
      color: var(--muted);
      user-select:none;
      margin-bottom: 6px;
      margin-left: 2px;
      animation: hintJitter 3.4s ease-in-out infinite;
      transform-origin: left center;
      font-weight: 800;
    }
    @keyframes hintJitter{
      0%,100%{ transform: translateX(0); }
      47%{ transform: translateX(1px); }
      53%{ transform: translateX(-1px); }
    }

    /* rating buttons match dark snow-night */
    .rateBtn{
      position: absolute;
      width: 84px;
      height: 32px;
      border-radius: 10px;

      background: var(--ice0);
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.22);

      user-select:none;
      outline:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;

      display:flex;
      align-items:center;
      justify-content:center;

      left: 0;
      top: 0;

      transform: translate3d(var(--x, 0px), var(--y, 0px), 0);
      transition: transform 70ms linear, filter 120ms ease, border-color 120ms ease;
      will-change: transform;
      z-index: 2;

      pointer-events: none; /* cursor never meets buttons */
    }
    .rateBtn:hover{ filter: brightness(1.12); border-color: rgba(255,255,255,0.34); }
    .rateBtn *{ pointer-events:none; }

    .inner{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 7px;
      width: 100%;
      height: 100%;
      font-size: 12px;
      font-weight: 950;
      transform: scale(1);
      transition: transform 70ms ease;
    }
    .rateBtn.flinch .inner{ transform: scale(0.66); }

    .tag{
      font-family: var(--mono);
      font-weight: 950;
      font-size: 10px;
      color: rgba(255,255,255,0.82);
    }

    .ropeOverlay{ position:absolute; inset:0; pointer-events:none; z-index:60; }
    .ropeLine{
      position:absolute;
      left: 0;
      top: 0;
      height: 2px;
      width: 120px;
      transform-origin: left center;
      background: repeating-linear-gradient(
        90deg,
        rgba(10,42,74,0.0) 0px,
        rgba(10,42,74,0.0) 6px,
        rgba(10,42,74,0.70) 6px,
        rgba(10,42,74,0.70) 9px
      );
      opacity: 0;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.06));
    }
    .ropeLine.on{ opacity: 1; }

    .pullScene{ position: relative; height: 120px; margin-top: -2px; width: 78%; }
    .pullBotWrap{
      position:absolute;
      right: 0;
      bottom: 0;
      width: 210px;
      height: 120px;
      border-radius: 16px;
      border: 1px solid rgba(217,230,241,0.95);
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 16px rgba(15,23,42,0.10);
      padding: 9px 10px;
      opacity: 0;
      transform: translateY(10px);
      animation: popIn 260ms ease-out forwards;
    }
    @keyframes popIn{ to{ opacity:1; transform: translateY(0); } }

    .pullBotHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
      user-select:none;
      font-weight: 900;
    }
    .pullBotHeader .name{ font-weight: 950; font-size: 11px; }
    .pullBotHeader .status{
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      white-space:nowrap;
      transform: translateY(1px);
      font-weight: 850;
    }

    .robot{ position:absolute; right: 10px; bottom: 8px; width: 145px; height: 98px; }

    .heldChip{
      position:absolute;
      left: 10px;
      bottom: 10px;
      height: 26px;
      padding: 0 9px;
      border-radius: 999px;
      border: 1px solid rgba(10,42,74,0.18);
      background: rgba(42,93,136,0.08);
      color: var(--text);
      display:flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      opacity: 0;
      transform: translateY(4px);
      animation: chipIn 220ms ease-out forwards;
      animation-delay: 820ms;
      white-space: nowrap;
      font-weight: 950;
    }
    @keyframes chipIn{ to{ opacity:1; transform: translateY(0); } }

    .armTug{
      transform-origin: 112px 44px;
      animation: tug 220ms ease-in-out infinite;
      animation-play-state: paused;
    }
    .tugging .armTug{ animation-play-state: running; }
    @keyframes tug{
      0%,100%{ transform: rotate(0deg) translateX(0); }
      50%{ transform: rotate(-9deg) translateX(-2px); }
    }

    .helpToast{
      position:absolute;
      left: 10px;
      bottom: 10px;
      font-family: var(--mono);
      font-size: 9px;
      color: rgba(10,42,74,0.88);
      background: rgba(255,255,255,0.72);
      border: 1px dashed rgba(42,93,136,0.25);
      padding: 6px 7px;
      border-radius: 10px;
      opacity: 0;
      transform: translateY(6px);
      pointer-events:none;
      user-select:none;
      max-width: 320px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      font-weight: 900;
      z-index: 70;
    }
    .helpToast.on{
      opacity: 1;
      transform: translateY(0);
      transition: opacity 140ms ease, transform 140ms ease;
    }

    /* üéÑ Emoji flood overlay */
    .emojiFlood{
      position:absolute;
      inset:0;
      z-index: 80;
      display:none;
      background: rgba(220, 246, 255, 0.94);
      backdrop-filter: blur(1px);
      padding: 10px;
    }
    .emojiFlood.on{ display:block; }
    .emojiFlood .grid{
      height: 100%;
      width: 100%;
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
      place-items:center;
      font-size: 18px;
      user-select:none;
      transform: rotate(1.2deg);
      opacity: 0.95;
    }
    .emojiFlood .caption{
      position:absolute;
      top: 8px;
      left: 10px;
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(10,42,74,0.75);
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(42,93,136,0.20);
      border-radius: 999px;
      padding: 4px 8px;
      font-weight: 900;
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <div class="ropeOverlay" aria-hidden="true">
      <div class="ropeLine" id="ropeLine"></div>
    </div>

    <div class="topbar">
      <div class="brand">
        <div class="name">RideBot</div>
        <div class="status" id="statusLine">Online ‚Ä¢ collecting snow-day vibes</div>
      </div>
      <!-- ‚úÖ Reset button removed -->
      <div class="fakeProgress" aria-hidden="true"><i></i></div>
    </div>

    <div class="chat" id="chat">
      <div class="row bot">
        <div class="avatar">ü§ñ</div>
        <div class="bubble">
          Welcome to <b>ConnX TransitIQ</b> ‚Äî tell us how your ride went.
          We‚Äôll handle your feedback like a winter timetable: brave, optimistic, and slightly fictional.
          <div class="meta">Tip: click <i>near</i> a rating. Direct contact is not permitted. For‚Ä¶ ‚Äúsafety‚Äù.</div>
        </div>
      </div>
    </div>

    <div class="ratingStage" id="stage" aria-label="Rating area">
      <div class="stageHint">
        <span>Click near a rating (auto-submits)</span>
        <!-- ‚úÖ removed "fits 500√ó350" label -->
      </div>

      <div class="helpToast" id="helpToast">Helpful tip: your cursor is not authorized to make contact.</div>

      <div class="emojiFlood" id="emojiFlood" aria-hidden="true">
        <div class="caption">Holiday Service Advisory: emoji replacement buses</div>
        <div class="grid" id="emojiGrid"></div>
      </div>

      <button class="rateBtn" type="button" data-rate="1" aria-label="Rate 1"><div class="inner"><span>üíÄ</span><span class="tag">-1</span></div></button>
      <button class="rateBtn" type="button" data-rate="2" aria-label="Rate 2"><div class="inner"><span>ü•∂</span><span class="tag">-2</span></div></button>
      <button class="rateBtn" type="button" data-rate="3" aria-label="Rate 3"><div class="inner"><span>ü§∑</span><span class="tag">-3</span></div></button>
      <button class="rateBtn" type="button" data-rate="4" aria-label="Rate 4"><div class="inner"><span>üî•</span><span class="tag">-4</span></div></button>
      <button class="rateBtn" type="button" data-rate="5" aria-label="Rate 5"><div class="inner"><span>‚ú®</span><span class="tag">-5</span></div></button>
    </div>
  </div>

  <script>
    const appRoot = document.getElementById('appRoot');
    const chat = document.getElementById('chat');
    const statusLine = document.getElementById('statusLine');
    const stage = document.getElementById('stage');
    const buttons = [...stage.querySelectorAll('.rateBtn')];
    const ropeLine = document.getElementById('ropeLine');
    const helpToast = document.getElementById('helpToast');
    const emojiFlood = document.getElementById('emojiFlood');
    const emojiGrid = document.getElementById('emojiGrid');

    let submitted = false;
    let isPulling = false;
    let stopHoverAndComments = false;

    const PAD = 10;
    const SAFE_GAP = 14;

    // tougher to click
    const HOP_COOLDOWN = 40;
    const CHAOS = 0.82;

    // cursor avoidance + hard click proximity
    const AVOID_RADIUS = 64;
    const CLICK_SNAP_RADIUS = 22;

    // every 5 hover attempts -> emoji flood 10s
    let hoverCount = 0;
    let floodActive = false;
    let floodTimer = null;
    const christmasEmojis = ["üéÑ","üéÖ","ü§∂","üßë‚ÄçüéÑ","ü¶å","üõ∑","üéÅ","üîî","‚ùÑÔ∏è","‚òÉÔ∏è","üåü","üïØÔ∏è","üç™","ü•õ","üç´","üß¶","üé∂","üß§","üß£","üßä"];

    const targets = [
      { ax: 0.06, ay: 0.20 }, { ax: 0.72, ay: 0.20 },
      { ax: 0.06, ay: 0.72 }, { ax: 0.72, ay: 0.72 },
      { ax: 0.39, ay: 0.20 }, { ax: 0.39, ay: 0.72 },
      { ax: 0.06, ay: 0.46 }, { ax: 0.72, ay: 0.46 },
      { ax: 0.39, ay: 0.46 },
    ];

    const laneOffsets = new Map();
    buttons.forEach((b, i) => laneOffsets.set(Number(b.dataset.rate), i));

    let hopIdx = 0;
    let lastHopAt = 0;

    const hoverComments = [
      "Approach detected. Dispatching evasive maneuvers.",
      "For your safety, the button has changed platforms.",
      "Contact not permitted. Please click the *idea* of the button.",
      "Your cursor is too confident. We fixed that.",
      "Transit policy: no direct connections without a transfer.",
      "Holiday schedule: all buttons are on a detour route.",
      "Mind the gap between your cursor and this rating.",
      "Snow day rules: the button is now ‚Äúoperating with delays.‚Äù"
    ];
    let lastHoverLine = "";

    const submitComments = {
      1: ["üíÄ Noted. Forwarded to ‚ÄòFeelings & Delays‚Äô.","A 1/5. Logged under: ‚Äòinvestigate everything‚Äô.","Route status: ‚Äòtemporarily suspended‚Äô."],
      2: ["ü•∂ A 2/5. Emotionally refrigerated.","Noted. Warming it up in a meeting next quarter.","Filed as: ‚Äòneeds improvement (festive edition)‚Äô."],
      3: ["ü§∑ A 3/5. The rating of: ‚Äòit happened‚Äô.","Neutral. Like a timetable PDF at 2% zoom.","A solid ‚Äòmeh‚Äô. Transit‚Äôs most consistent KPI."],
      4: ["üî• A 4/5! Printing this for morale.","Nice. If only transfers were this successful.","Classified as: ‚Äòsurprisingly fine‚Äô."],
      5: ["‚ú® A 5/5?! Are you rating the ride or the concept of transit?","Incredible. This will be used to justify everything.","Citing this in ‚ÄòCustomer Delight (Real)‚Äô."]
    };
    let lastSubmitLine = "";

    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
    function pickNoRepeat(arr, last){
      if (arr.length <= 1) return arr[0] || "";
      let v = pick(arr);
      while (v === last) v = pick(arr);
      return v;
    }
    function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }

    function addBubble(who, html, meta){
      const row = document.createElement('div');
      row.className = `row ${who}`;
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = who === 'bot' ? 'ü§ñ' : 'üßë';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = html;
      if (meta){
        const m = document.createElement('div');
        m.className = 'meta';
        m.textContent = meta;
        bubble.appendChild(m);
      }
      if (who === 'bot'){ row.appendChild(avatar); row.appendChild(bubble); }
      else { row.appendChild(bubble); row.appendChild(avatar); }
      chat.appendChild(row);
      scrollToBottom();
    }

    function botTalk(text){
      if (stopHoverAndComments) return;
      addBubble('bot', text, Math.random() < 0.5 ? "snow mode: on" : "ETA: unknown");
    }

    function setPos(btn, x, y){
      btn.style.setProperty("--x", `${x}px`);
      btn.style.setProperty("--y", `${y}px`);
    }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function getStageMetrics(btn){
      const stageRect = stage.getBoundingClientRect();
      const btnRect = btn.getBoundingClientRect();
      const hint = stage.querySelector('.stageHint');
      const hintRect = hint.getBoundingClientRect();
      const usableTop = (hintRect.height + 8);
      const usableHeight = stageRect.height - usableTop;
      const usableWidth = stageRect.width;
      return { usableTop, usableWidth, usableHeight, btnW: btnRect.width, btnH: btnRect.height };
    }

    function computeTargetPixel(ax, ay, btn){
      const m = getStageMetrics(btn);
      const minX = PAD;
      const maxX = m.usableWidth - m.btnW - PAD;
      const minY = m.usableTop + PAD;
      const maxY = m.usableTop + (m.usableHeight - m.btnH - PAD);
      const x = clamp(minX + ax * (maxX - minX), minX, maxX);
      const y = clamp(minY + ay * (maxY - minY), minY, maxY);
      return { x, y, m };
    }

    function separatePositions(pos, btnW, btnH){
      const minDX = btnW + SAFE_GAP;
      const minDY = btnH + 10;
      for (let iter = 0; iter < 10; iter++){
        let moved = false;
        for (let i = 0; i < pos.length; i++){
          for (let j = i + 1; j < pos.length; j++){
            const a = pos[i], b = pos[j];
            const dx = b.x - a.x;
            const dy = b.y - a.y;
            if (Math.abs(dx) < minDX && Math.abs(dy) < minDY){
              const push = 10;
              if (Math.abs(dx) <= Math.abs(dy)){
                const dir = dx >= 0 ? 1 : -1;
                b.x += dir * push; a.x -= dir * push;
              } else {
                const dir = dy >= 0 ? 1 : -1;
                b.y += dir * push; a.y -= dir * push;
              }
              moved = true;
            }
          }
        }
        if (!moved) break;
      }
    }

    function placeInitial(){
      const first = buttons[0];
      const m = getStageMetrics(first);
      const gap = Math.max(SAFE_GAP, 12);
      const totalW = buttons.length * m.btnW + (buttons.length - 1) * gap;

      const startX = clamp((m.usableWidth - totalW) / 2, PAD, m.usableWidth - totalW - PAD);
      const y = clamp(m.usableTop + 10, m.usableTop + PAD, m.usableTop + (m.usableHeight - m.btnH - PAD));

      buttons.forEach((btn, i) => {
        btn.style.opacity = "1";
        btn.classList.remove("flinch");
        btn.style.transition = "transform 70ms linear, filter 120ms ease, border-color 120ms ease";
        btn.style.transform = `translate3d(var(--x, 0px), var(--y, 0px), 0)`;
        setPos(btn, startX + i * (m.btnW + gap), y);
      });

      ropeLine.classList.remove("on");
      ropeLine.style.width = "0px";
    }

    function hopAllButtons(hoveredBtn){
      if (stopHoverAndComments || submitted || isPulling) return;
      if (floodActive) return;

      const now = Date.now();
      if (now - lastHopAt < HOP_COOLDOWN) return;
      lastHopAt = now;

      hopIdx++;
      const hoveredRate = Number(hoveredBtn.dataset.rate);

      const sample = getStageMetrics(hoveredBtn);
      const proposed = [];

      buttons.forEach((btn) => {
        const rate = Number(btn.dataset.rate);
        const lane = laneOffsets.get(rate) ?? 0;
        const extra = (rate === hoveredRate) ? 3 : 0;

        const t = targets[(hopIdx + lane + extra) % targets.length];
        const out = computeTargetPixel(t.ax, t.ay, btn);

        const jx = (Math.random() - 0.5) * 22 * CHAOS;
        const jy = (Math.random() - 0.5) * 18 * CHAOS;

        proposed.push({ btn, x: out.x + jx, y: out.y + jy, m: out.m });
      });

      separatePositions(proposed, sample.btnW, sample.btnH);

      proposed.forEach(p => {
        const m = p.m;
        const minX = PAD;
        const maxX = m.usableWidth - m.btnW - PAD;
        const minY = m.usableTop + PAD;
        const maxY = m.usableTop + (m.usableHeight - m.btnH - PAD);
        p.x = clamp(p.x, minX, maxX);
        p.y = clamp(p.y, minY, maxY);
      });

      proposed.forEach(p => setPos(p.btn, p.x, p.y));
    }

    function startEmojiFlood(){
      if (floodActive || stopHoverAndComments || submitted || isPulling) return;
      floodActive = true;

      emojiGrid.innerHTML = "";
      for (let i = 0; i < 90; i++){
        const cell = document.createElement("div");
        cell.textContent = christmasEmojis[Math.floor(Math.random() * christmasEmojis.length)];
        emojiGrid.appendChild(cell);
      }
      emojiFlood.classList.add("on");

      clearTimeout(floodTimer);
      floodTimer = setTimeout(() => {     // ‚úÖ 10 seconds
        emojiFlood.classList.remove("on");
        emojiGrid.innerHTML = "";
        floodActive = false;
      }, 5_000);
    }

    function countHoverAndMaybeFlood(){
      hoverCount++;
      if (hoverCount % 5 === 0){
        botTalk("üéÑ Holiday Service Update: The rating panel has been replaced by seasonal emojis for 5 seconds. Please remain calm and festive.");
        startEmojiFlood();
      }
    }

    function getBtnCenter(btn){
      const sx = parseFloat(getComputedStyle(btn).getPropertyValue("--x")) || 0;
      const sy = parseFloat(getComputedStyle(btn).getPropertyValue("--y")) || 0;
      const bw = btn.offsetWidth, bh = btn.offsetHeight;
      return { x: sx + bw/2, y: sy + bh/2 };
    }

    function dodgeIfTooClose(mouseX, mouseY){
      if (stopHoverAndComments || submitted || isPulling) return;
      if (floodActive) return;

      let forcedHop = false;
      for (const btn of buttons){
        const c = getBtnCenter(btn);
        const dx = c.x - mouseX;
        const dy = c.y - mouseY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < AVOID_RADIUS){
          btn.classList.add("flinch");
          setTimeout(() => btn.classList.remove("flinch"), 110);
          forcedHop = true;
        }
      }
      if (forcedHop){
        countHoverAndMaybeFlood();
        hopAllButtons(buttons[Math.floor(Math.random()*buttons.length)]);
        const line = pickNoRepeat(hoverComments, lastHoverLine);
        lastHoverLine = line;
        botTalk(line);
      }
    }

    function nearestButton(mouseX, mouseY){
      let best = null;
      let bestD = Infinity;
      for (const btn of buttons){
        const c = getBtnCenter(btn);
        const dx = c.x - mouseX;
        const dy = c.y - mouseY;
        const d = Math.sqrt(dx*dx + dy*dy);
        if (d < bestD){ bestD = d; best = btn; }
      }
      return { btn: best, d: bestD };
    }

    function getCenterInApp(el){
      const r = el.getBoundingClientRect();
      const a = appRoot.getBoundingClientRect();
      return { x: (r.left - a.left) + r.width/2, y: (r.top - a.top) + r.height/2, r };
    }

    function drawRope(from, to){
      const dx = to.x - from.x;
      const dy = to.y - from.y;
      const len = Math.max(20, Math.sqrt(dx*dx + dy*dy));
      const angle = Math.atan2(dy, dx) * (180/Math.PI);
      ropeLine.style.left = `${from.x}px`;
      ropeLine.style.top  = `${from.y}px`;
      ropeLine.style.width = `${len}px`;
      ropeLine.style.transform = `rotate(${angle}deg)`;
      ropeLine.classList.add("on");
    }
    function clearRope(){ ropeLine.classList.remove("on"); }
    const delay = (ms) => new Promise(r => setTimeout(r, ms));

    function autoResetAfterSubmit(){
      // restore buttons + allow hover/comments again
      submitted = false;
      isPulling = false;
      stopHoverAndComments = false;
      statusLine.textContent = "Online ‚Ä¢ collecting snow-day vibes";
      placeInitial();
      botTalk("Reset complete. Rate Now (we regret to inform you the buttons are still evasive).");
    }

    async function onClick(btn){
      if (submitted || isPulling) return;

      stopHoverAndComments = true;   // stop hover + hover comments while submit animation runs
      submitted = true;
      isPulling = true;

      emojiFlood.classList.remove("on");
      emojiGrid.innerHTML = "";
      floodActive = false;

      helpToast.classList.remove("on");
      statusLine.textContent = "Online ‚Ä¢ rating locked";

      const rate = Number(btn.dataset.rate);
      const emojiMap = {1:"üíÄ",2:"ü•∂",3:"ü§∑",4:"üî•",5:"‚ú®"};

      addBubble('user', `I rate my ride <b>${rate}/5</b>.`);

      const sceneRow = document.createElement('div');
      sceneRow.className = 'row user';
      sceneRow.innerHTML = `
        <div style="width:24px;"></div>
        <div class="pullScene">
          <div class="pullBotWrap tugging" id="pullBotWrap">
            <div class="pullBotHeader">
              <div class="name">ConnX Bot</div>
              <div class="status" id="pullStatus">aiming‚Ä¶</div>
            </div>

            <div class="heldChip" id="heldChip"><span>${emojiMap[rate]}</span><span>${rate}/5</span></div>

            <svg class="robot" viewBox="0 0 180 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <ellipse cx="92" cy="120" rx="58" ry="8" fill="rgba(15,23,42,0.08)"/>
              <rect x="72" y="92" width="16" height="28" rx="7" fill="rgba(10,42,74,0.08)" stroke="rgba(10,42,74,0.14)"/>
              <rect x="96" y="92" width="16" height="28" rx="7" fill="rgba(10,42,74,0.08)" stroke="rgba(10,42,74,0.14)"/>
              <rect x="58" y="54" width="68" height="50" rx="18" fill="white" stroke="rgba(10,42,74,0.18)"/>
              <rect x="66" y="64" width="52" height="18" rx="9" fill="rgba(10,42,74,0.05)" stroke="rgba(10,42,74,0.12)"/>
              <circle cx="80" cy="73" r="3.6" fill="rgba(10,42,74,0.70)"/>
              <circle cx="104" cy="73" r="3.6" fill="rgba(10,42,74,0.70)"/>
              <rect x="88" y="82" width="8" height="6" rx="3" fill="rgba(10,42,74,0.20)"/>
              <rect x="64" y="16" width="56" height="44" rx="16" fill="white" stroke="rgba(10,42,74,0.18)"/>
              <rect x="72" y="26" width="40" height="14" rx="7" fill="rgba(10,42,74,0.05)" stroke="rgba(10,42,74,0.12)"/>
              <circle cx="84" cy="33" r="3.2" fill="rgba(10,42,74,0.70)"/>
              <circle cx="100" cy="33" r="3.2" fill="rgba(10,42,74,0.70)"/>
              <line x1="92" y1="16" x2="92" y2="6" stroke="rgba(10,42,74,0.25)" stroke-width="3" stroke-linecap="round"/>
              <circle cx="92" cy="4" r="4" fill="rgba(10,42,74,0.10)" stroke="rgba(10,42,74,0.18)"/>
              <g>
                <rect x="40" y="62" width="22" height="12" rx="6" fill="rgba(10,42,74,0.08)" stroke="rgba(10,42,74,0.14)"/>
                <circle cx="38" cy="68" r="7" fill="rgba(10,42,74,0.08)" stroke="rgba(10,42,74,0.14)"/>
              </g>
              <g class="armTug">
                <rect x="124" y="58" width="26" height="14" rx="7" fill="rgba(10,42,74,0.08)" stroke="rgba(10,42,74,0.14)"/>
                <circle cx="154" cy="65" r="8" fill="rgba(10,42,74,0.08)" stroke="rgba(10,42,74,0.14)"/>
                <rect x="158" y="61" width="12" height="8" rx="4" fill="rgba(10,42,74,0.12)" stroke="rgba(10,42,74,0.14)"/>
              </g>
            </svg>
          </div>
        </div>
        <div class="avatar">üßë</div>
      `;
      chat.appendChild(sceneRow);
      scrollToBottom();

      await delay(160);

      const wrap = sceneRow.querySelector('#pullBotWrap');
      const status = sceneRow.querySelector('#pullStatus');
      const heldChip = sceneRow.querySelector('#heldChip');

      const botPoint = getCenterInApp(wrap);
      const btnPoint = getCenterInApp(btn);

      const from = { x: botPoint.x + botPoint.r.width/2 - 22, y: botPoint.y + 8 };
      const to   = { x: btnPoint.x, y: btnPoint.y + 6 };

      status.textContent = "throwing rope‚Ä¶";
      drawRope(from, to);

      await delay(220);

      status.textContent = "pulling‚Ä¶";

      const a = appRoot.getBoundingClientRect();
      const btnRect = btnPoint.r;

      const currX = Number(getComputedStyle(btn).getPropertyValue("--x").replace("px","")) || 0;
      const currY = Number(getComputedStyle(btn).getPropertyValue("--y").replace("px","")) || 0;

      const btnAbsX = (btnRect.left - a.left);
      const btnAbsY = (btnRect.top - a.top);

      const target = { x: botPoint.x - (btnRect.width/2) + 6, y: botPoint.y + 16 };
      const deltaAbsX = target.x - btnAbsX;
      const deltaAbsY = target.y - btnAbsY;

      btn.style.transition = "transform 820ms cubic-bezier(.16,.9,.18,1)";
      btn.style.transform = `translate3d(${currX + deltaAbsX}px, ${currY + deltaAbsY}px, 0) rotate(-8deg)`;

      await delay(850);

      btn.style.opacity = "0";
      clearRope();
      status.textContent = "secured.";
      wrap.classList.remove("tugging");
      heldChip.style.animationDelay = "0ms";

      const pool = submitComments[rate] || ["Noted."];
      const line = pickNoRepeat(pool, lastSubmitLine);
      lastSubmitLine = line;


      // ‚úÖ Auto-reset the rating buttons after submission
      setTimeout(autoResetAfterSubmit, 2600);
    }

    stage.addEventListener('mousemove', (e) => {
      if (stopHoverAndComments || submitted || isPulling) return;

      const r = stage.getBoundingClientRect();
      const mx = e.clientX - r.left;
      const my = e.clientY - r.top;

      dodgeIfTooClose(mx, my);

      if (!floodActive && Math.random() < 0.012 * CHAOS){
        helpToast.classList.add('on');
        helpToast.textContent = pick([
          "Helpful tip: your cursor is not authorized to make contact.",
          "Helpful tip: click closer. No, closer than that.",
          "Helpful tip: transfers required.",
          "Helpful tip: mind the snow-gapped gap."
        ]);
        setTimeout(() => helpToast.classList.remove('on'), 850);
      }
    });

    stage.addEventListener('click', (e) => {
      if (submitted || isPulling) return;
      if (floodActive) return;

      const r = stage.getBoundingClientRect();
      const mx = e.clientX - r.left;
      const my = e.clientY - r.top;

      const { btn, d } = nearestButton(mx, my);

      if (btn && d <= CLICK_SNAP_RADIUS){
        onClick(btn);
      } else {
        buttons.forEach(b => {
          b.classList.add("flinch");
          setTimeout(() => b.classList.remove("flinch"), 110);
        });
        hopAllButtons(btn || buttons[0]);

        countHoverAndMaybeFlood();

        const line = pickNoRepeat(hoverComments, lastHoverLine);
        lastHoverLine = line;
        botTalk(line);
      }
    });

    window.addEventListener('load', placeInitial);
    window.addEventListener('resize', () => {
      if (!submitted && !isPulling) placeInitial();
    });
  </script>
</body>
</html>
